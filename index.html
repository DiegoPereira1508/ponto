<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Registro de Ponto</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        h1, h2 { margin-top: 20px; }
        #status { font-weight: bold; color: green; }
    </style>
</head>
<body>

<h1>Registrar Ponto</h1>
<p>Data de hoje: <span id="dataHoje"></span></p>

<select id="tipoTrabalho">
    <option value="Elétrica">Elétrica</option>
    <option value="Hidráulica">Hidráulica</option>
    <option value="Manutenção Civil">Manutenção Civil</option>
</select>

<button onclick="registrarEntrada()">Entrada</button>
<button onclick="registrarSaida()">Saída</button>
<button onclick="limparRegistros()">Limpar Registros</button>
<button onclick="exportarCSV()">Exportar CSV</button>
<button onclick="sair()">Sair</button>

<h2>Registros do Dia</h2>
<ul id="registrosDoDia"></ul>
<p id="totalHoje">Total hoje: 0 min</p>
<p id="pagamentoHoje">Pagamento hoje: R$ 0,00</p>
<p>Status: <span id="status">Nenhum registro</span></p>

<h2>Resumo Mensal</h2>
<div id="resumoMensal"></div>
<p id="totalPagamento">Total a receber no mês: R$ 0,00</p>

<script>
let registros = JSON.parse(localStorage.getItem('registros')) || [];
const valoresHora = {
    "Elétrica": 103.00,
    "Hidráulica": 97.50,
    "Manutenção Civil": 97.00
};

function registrarEntrada() {
    const tipo = document.getElementById('tipoTrabalho').value;
    registros.push({ tipo, acao: 'Entrada', hora: obterHoraAtual(), data: dataAtual() });
    salvarRegistros();
    atualizarTela();
}

function registrarSaida() {
    const tipo = document.getElementById('tipoTrabalho').value;
    const hoje = dataAtual();
    const ultEntrada = registros.findLast(r => r.tipo === tipo && r.acao === 'Entrada' && r.data === hoje);

    if (!ultEntrada) {
        alert(`Não há entrada registrada para ${tipo} hoje.`);
        return;
    }
    
    registros.push({ tipo, acao: 'Saída', hora: obterHoraAtual(), data: dataAtual() });
    salvarRegistros();
    atualizarTela();
}

function obterHoraAtual() {
    return new Date().toTimeString().slice(0, 5);
}

function dataAtual() {
    return new Date().toLocaleDateString('pt-BR');
}

function salvarRegistros() {
    localStorage.setItem('registros', JSON.stringify(registros));
}

function limparRegistros() {
    registros = [];
    salvarRegistros();
    atualizarTela();
}

function sair() {
    if (confirm('Tem certeza que deseja sair?')) {
        window.close();
    }
}

function atualizarTela() {
    document.getElementById('dataHoje').textContent = dataAtual();
    mostrarRegistrosDoDia();
    calcularTotalHoje();
    atualizarResumoMensal();
    atualizarStatus();
}

function mostrarRegistrosDoDia() {
    const lista = document.getElementById('registrosDoDia');
    lista.innerHTML = '';
    const hoje = dataAtual();
    registros.filter(r => r.data === hoje).forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.acao} - ${r.tipo}: ${r.hora}`;
        lista.appendChild(li);
    });
}

function calcularTotalHoje() {
    const hoje = dataAtual();
    const registrosHoje = registros.filter(r => r.data === hoje);
    let totalMinutos = 0;
    let totalPagamento = 0;
    
    for (let i = 0; i < registrosHoje.length; i += 2) {
        if (registrosHoje[i + 1]) {
            const minutos = diferencaMinutos(registrosHoje[i].hora, registrosHoje[i + 1].hora);
            totalMinutos += minutos;
            totalPagamento += (valoresHora[registrosHoje[i].tipo] / 60) * minutos;
        }
    }
    
    document.getElementById('totalHoje').textContent = `Total hoje: ${totalMinutos} min`;
    document.getElementById('pagamentoHoje').textContent = `Pagamento hoje: R$ ${totalPagamento.toFixed(2)}`;
}

function atualizarResumoMensal() {
    let totalPagamento = 0;
    registros.forEach(r => {
        if (r.acao === 'Saída') {
            const entrada = registros.find(e => e.tipo === r.tipo && e.acao === 'Entrada' && e.data === r.data);
            if (entrada) {
                const minutos = diferencaMinutos(entrada.hora, r.hora);
                totalPagamento += (valoresHora[r.tipo] / 60) * minutos;
            }
        }
    });
    document.getElementById('totalPagamento').textContent = `Total a receber no mês: R$ ${totalPagamento.toFixed(2)}`;
}

function atualizarStatus() {
    const hoje = dataAtual();
    const registrosHoje = registros.filter(r => r.data === hoje);
    const temEntrada = registrosHoje.some(r => r.acao === 'Entrada');
    const temSaida = registrosHoje.some(r => r.acao === 'Saída');
    
    const status = document.getElementById('status');
    if (temEntrada && !temSaida) {
        status.textContent = 'Em andamento';
        status.style.color = 'orange';
    } else if (temEntrada && temSaida) {
        status.textContent = 'Concluído';
        status.style.color = 'green';
    } else {
        status.textContent = 'Nenhum registro';
        status.style.color = 'red';
    }
}

function exportarCSV() {
    let csv = "Data;Tipo;Ação;Hora;Horas Trabalhadas;Pagamento\n";
    registros.forEach(r => {
        const entrada = registros.find(e => e.tipo === r.tipo && e.acao === 'Entrada' && e.data === r.data);
        let minutos = 0, pagamento = 0;
        if (entrada && r.acao === 'Saída') {
            minutos = diferencaMinutos(entrada.hora, r.hora);
            pagamento = (valoresHora[r.tipo] / 60) * minutos;
        }
        csv += `${r.data};${r.tipo};${r.acao};${r.hora};${(minutos/60).toFixed(2)};R$ ${pagamento.toFixed(2)}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'registros_ponto.csv';
    link.click();
}

window.onload = atualizarTela;
</script>
</body>
</html>
